fastlane_version '2.140.0'

def getCLIArgEnvName (currentArgs, argName)
  return "CLI_ARG_" + argName.underscore.upcase + "_{{CLI_BUILD_ID}}";
end

platform :android do
  desc 'Build the Android application.'
  lane :build do

    nativescriptCLICommand = ["tns", "build", "android", "--copy-to", "{{OUTPUT_DIR}}/app.apk"];
    if ENV[getCLIArgEnvName("release")]
      nativescriptCLICommand.push("--release");
    end

    # TODO: reuse for cache skipping?
    if ENV[getCLIArgEnvName("clean")]
      nativescriptCLICommand.push("--clean");
    end

    if ENV[getCLIArgEnvName("key-store")]
      keyStoreContent = Base64.decode64(ENV[getCLIArgEnvName("key-store")]);
      keyStoreFilePath = File.join(File.expand_path("{{PROJECT_DIR}}"), "__envKeystore");
      keyStoreDirPath = File.dirname(keyStoreFilePath)
      unless File.directory?(keyStoreDirPath)
        FileUtils.mkdir_p(keyStoreDirPath)
      end
      File.open(keyStoreFilePath, "wb") do |f|
        f.write(keyStoreContent)
      end
      nativescriptCLICommand.push("--key-store-path", keyStoreFilePath);
    end

    if ENV[getCLIArgEnvName("key-store-password")]
      nativescriptCLICommand.push("--key-store-password", Shellwords.shellescape(ENV[getCLIArgEnvName("key-store-password")]));
    end

    if ENV[getCLIArgEnvName("key-store-alias")]
      nativescriptCLICommand.push("--key-store-alias", Shellwords.shellescape(ENV[getCLIArgEnvName("key-store-alias")]));
    end

    if ENV[getCLIArgEnvName("key-store-alias-password")]
      nativescriptCLICommand.push("--key-store-alias-password", Shellwords.shellescape(ENV[getCLIArgEnvName("key-store-alias-password")]));
    end

    sh(nativescriptCLICommand);
  end
 
 end