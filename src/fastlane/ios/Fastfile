fastlane_version '2.140.0'

platform :ios do
 before_all do
   setup_circle_ci
 end

 desc 'Build the iOS application.'
 lane :build do
    disable_automatic_code_signing(
      path: "{{IOS_XCODE_PROJ_PATH}}"
    )

    MY_APP_ID = "{{PROJECT_ID}}"
    MY_PROFILE = "{{IOS_DEV_PROVISION_NAME}}"
    MY_TEAM = "{{IOS_TEAM_ID}}"

    match(
        type: "{{BUILD_TYPE}}"
    )

    settings_to_override = {
      :PROVISIONING_PROFILE_SPECIFIER => MY_PROFILE,
      :DEVELOPMENT_TEAM => MY_TEAM,
    }

    gym(
      scheme: "{{PROJECT_NAME}}",
      workspace: "{{IOS_XCODE_WORKSPACE_PATH}}",
      export_method: '{{BUILD_TYPE}}',
      configuration: "{{BUILD_CONFIGURATION}}",
      destination: {{IOS_BUILD_FOR_SIMULATOR}} ? 'generic/platform=iOS Simulator' : 'generic/platform=iOS',
      skip_package_ipa: {{IOS_BUILD_FOR_SIMULATOR}} ? true : false,
      archive_path: File.expand_path('~/fl_output/{{PROJECT_NAME}}'),
      xcargs: settings_to_override,
    )

    if ({{IOS_BUILD_FOR_SIMULATOR}})
      zip(
        path: File.expand_path("~/fl_output/{{PROJECT_NAME}}.xcarchive/Products/Applications/{{PROJECT_NAME}}.app"),
        output_path: File.expand_path("~/fl_output/{{PROJECT_NAME}}.app.zip")
      )
    end
 end

end